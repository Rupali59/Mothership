# =============================================================================
# Local Development - Single Container Platform
# =============================================================================
# All Motherboard platform services run in ONE container (motherboard).
# Infrastructure (redis, mongodb, minio) runs as separate containers.
#
# Usage:
#   Platform only:     docker compose -f docker-compose.dev.yml up
#   With clients:      docker compose -f docker-compose.dev.yml -f docker-compose.clients.dev.yml up
#
# Production (unchanged):
#   docker compose -f docker-compose.yml -f docker-compose.prod.yml up
# =============================================================================

services:
  # --------------------------------------------------------------------------
  # Infrastructure
  # --------------------------------------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: motherboard-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - motherboard-network
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s

  minio:
    image: minio/minio:latest
    container_name: motherboard-minio
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
    volumes:
      - minio_data:/data
    networks:
      - motherboard-network

  mongodb:
    image: mongo:7.0
    container_name: motherboard-mongodb
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_DATABASE: motherboard
    volumes:
      - mongodb_data:/data/db
    networks:
      - motherboard-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/motherboard --quiet
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # --------------------------------------------------------------------------
  # Motherboard Platform (all services in one container)
  # --------------------------------------------------------------------------
  motherboard:
    build:
      context: .
      dockerfile: docker/Dockerfile.platform
    container_name: motherboard
    ports:
      - "8080:8080"   # backend
      - "3000:3000"   # frontend
      - "8081:8081"   # email
      - "8082:8082"   # sms
      - "8083:8083"   # whatsapp
      - "8084:8084"   # telegram
      - "8085:8085"   # entitlement
      - "8086:8086"   # razorpay
      - "8087:8087"   # stripe
      - "8090:8090"   # billing
      - "8091:8091"   # health
      - "8092:8092"   # marketing
      - "8093:8093"   # cloud-adapter
      - "8094:8094"   # notification
      - "8096:8096"   # inventory
      - "8097:8097"   # orders
      - "8098:8098"   # storage
      - "3130:3130"   # jhora
      - "3140:3140"   # vedika
    environment:
      # Common
      - APP_ENV=${APP_ENV:-development}
      - LOG_LEVEL=${LOG_LEVEL:-debug}
      # Database
      - MONGODB_URI=mongodb://mongodb:27017
      - DATABASE_NAME=motherboard
      - REDIS_URL=redis://redis:6379
      # Storage (minio)
      - S3_ENDPOINT=http://minio:9000
      - S3_BUCKET=motherboard-assets
      - S3_REGION=us-east-1
      - S3_ACCESS_KEY=${MINIO_ROOT_USER:-minioadmin}
      - S3_SECRET_KEY=${MINIO_ROOT_PASSWORD:-minioadmin}
      - S3_USE_PATH_STYLE=true
      # Inter-service URLs (all localhost - same container)
      - EMAIL_PLUGIN_URL=http://localhost:8081
      - SMS_PLUGIN_URL=http://localhost:8082
      - WHATSAPP_PLUGIN_URL=http://localhost:8083
      - TELEGRAM_PLUGIN_URL=http://localhost:8084
      - BILLING_SERVICE_URL=http://localhost:8090
      - HEALTH_SERVICE_URL=http://localhost:8091
      - ENTITLEMENT_SERVICE_URL=http://localhost:8085
      - JHORA_SERVICE_URL=http://localhost:3130
      - VEDIKA_SERVICE_URL=http://localhost:3140
      - MARKETING_SERVICE_URL=http://localhost:8092
      - CLOUD_ADAPTER_URL=http://localhost:8093
      - NOTIFICATION_SERVICE_URL=http://localhost:8094
      - STORAGE_SERVICE_URL=http://localhost:8098
      - RAZORPAY_PLUGIN_URL=http://localhost:8086
      - STRIPE_PLUGIN_URL=http://localhost:8087
      - INVENTORY_SERVICE_URL=http://localhost:8096
      - BACKEND_URL=http://localhost:8080
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-http://localhost:3000}
      # Astrology
      - JHORA_API_URL=${JHORA_API_URL:-http://host.docker.internal:3129}
      - VEDIKA_API_URL=${VEDIKA_API_URL:-https://api.vedika.io/v2/astrology}
      - VEDIKA_API_KEY=${VEDIKA_API_KEY}
      - CACHE_TTL=604800
      # Billing DB
      - DB_NAME=billing
    env_file:
      - path: ./.env
        required: false
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - motherboard-network
    stop_grace_period: 30s
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:8080/readyz" ]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 30s

networks:
  motherboard-network:
    driver: bridge

volumes:
  redis_data:
    driver: local
  minio_data:
    driver: local
  mongodb_data:
    driver: local
