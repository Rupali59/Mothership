# Production overrides for docker-compose.yml
# Usage: docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d

services:
  # MongoDB - Production Configuration
  mongodb:
    environment:
      MONGO_INITDB_DATABASE: motherboard
      # Add authentication in production
      # MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USER}
      # MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD}
    volumes:
      - mongodb_data:/data/db
      - mongodb_backup:/backup
    restart: always
    command: mongod --auth
    # Uncomment for backups
    # command: >
    #   sh -c "mongod --auth &
    #   while ! mongosh --eval 'db.runCommand({ ping: 1 })'; do sleep 1; done;
    #   echo '0 */6 * * * mongodump --out /backup/\$$(date +\\%Y\\%m\\%d_\\%H\\%M\\%S) --gzip' | crontab -;
    #   crond -f"

    # Core Platform - Backend
  backend:
    environment:
      - APP_ENV=production
      - LOG_LEVEL=info
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-https://yourdomain.com}
      - MONGODB_URI=mongodb://mongodb:27017
      - DATABASE_NAME=motherboard
    env_file:
      - ./apps/core-server/.env.production
    restart: always
    # Remove volume mount for production (use built image)
    volumes: []

  # Core Platform - Frontend
  frontend:
    build:
      context: ./apps/frontend
      dockerfile: Dockerfile
      target: production
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_URL=${BACKEND_URL:-https://api.yourdomain.com}
      - NEXTAUTH_URL=${FRONTEND_URL:-https://yourdomain.com}
    env_file:
      - ./apps/frontend/.env.production
    restart: always
    volumes: []

  # Scheduler
  scheduler:
    environment:
      - LOG_LEVEL=info
    env_file:
      - ./services/scheduler/.env.production
    restart: always
    volumes: []

  # Billing Service
  billing:
    environment:
      - APP_ENV=production
      - LOG_LEVEL=info
    env_file:
      - ./services/billing/.env.production
    restart: always
    volumes: []

  # Health Service
  health:
    environment:
      - LOG_LEVEL=info
    env_file:
      - ./services/health/.env.production
    restart: always
    volumes: []

  # Marketing Service
  marketing:
    environment:
      - APP_ENV=production
    env_file:
      - ./services/marketing/.env.production
    restart: always
    volumes: []

  # Cloud Adapter
  cloud-adapter:
    environment:
      - APP_ENV=production
    env_file:
      - ./services/cloud-adapter/.env.production
    restart: always
    volumes: []

  # Notification Service
  notification:
    environment:
      - APP_ENV=production
      - LOG_LEVEL=info
    env_file:
      - ./services/notification/.env.production
    restart: always
    volumes: []

  # Email Plugin
  email:
    environment:
      - APP_ENV=production
    env_file:
      - ./plugins/email/.env.production
    restart: always
    volumes: []

  # SMS Plugin
  sms:
    environment:
      - APP_ENV=production
    env_file:
      - ./plugins/sms/.env.production
    restart: always
    volumes: []

  # WhatsApp Plugin
  whatsapp:
    environment:
      - APP_ENV=production
    env_file:
      - ./plugins/whatsapp/.env.production
    restart: always
    volumes: []

  # Telegram Plugin
  telegram:
    environment:
      - APP_ENV=production
    env_file:
      - ./plugins/telegram/.env.production
    restart: always
    volumes: []

  # Inventory Management
  inventory:
    env_file:
      - ./services/inventory-management/.env.production
    restart: always
    volumes: []

  # Order Management
  orders:
    env_file:
      - ./services/order-management/.env.production
    restart: always
    volumes: []

  # Reverse Proxy / Load Balancer (Traefik)
  traefik:
    image: traefik:v2.10
    container_name: motherboard-traefik
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/traefik.yml:/traefik.yml:ro
      - ./traefik/acme.json:/acme.json
      - traefik_certs:/certs
    networks:
      - motherboard-network
    restart: always
    command:
      - "--api.dashboard=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL:-admin@yourdomain.com}"
      - "--certificatesresolvers.letsencrypt.acme.storage=/acme.json"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard.rule=Host(`traefik.yourdomain.com`)"
      - "traefik.http.routers.dashboard.service=api@internal"
      - "traefik.http.routers.dashboard.middlewares=auth"
      - "traefik.http.middlewares.auth.basicauth.users=${TRAEFIK_AUTH:-admin:$$apr1$$H6uskkkW$$IgXLP6ewTrSuBkTrqE8wj/}"

volumes:
  mongodb_data:
    driver: local
  mongodb_backup:
    driver: local
  traefik_certs:
    driver: local
