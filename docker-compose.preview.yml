# Production-like preview environment
# Usage: docker-compose -f docker-compose.yml -f docker-compose.preview.yml up -d
#
# Differences from production:
#   - Nginx instead of Traefik (no SSL/domain required)
#   - restart: unless-stopped (not always)
#   - Exposed on localhost:80 (frontend) and localhost:8080 (backend)
#   - Uses .env.preview files

services:
  # Core Platform
  backend:
    environment:
      - APP_ENV=preview
      - LOG_LEVEL=info
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-http://localhost}
    env_file:
      - ./.ports.env
      - ./apps/motherboard/backend/.env.preview
    restart: unless-stopped
    volumes: []

  frontend:
    build:
      context: ./apps/motherboard/frontend
      dockerfile: Dockerfile
      target: production
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_MOTHERBOARD_API_URL=${BACKEND_URL:-http://localhost:8080}
      - NEXTAUTH_URL=${FRONTEND_URL:-http://localhost}
    env_file:
      - ./.ports.env
      - ./apps/motherboard/frontend/.env.preview
    restart: unless-stopped
    volumes: []

  scheduler:
    environment:
      - APP_ENV=preview
      - LOG_LEVEL=info
    env_file:
      - ./.ports.env
      - ./services/scheduler/.env.preview
    restart: unless-stopped
    volumes: []

  # Microservices
  auth:
    environment:
      - APP_ENV=preview
    env_file:
      - ./.ports.env
      - ./services/auth/.env.preview
    restart: unless-stopped
    volumes: []

  entitlement:
    environment:
      - APP_ENV=preview
    env_file:
      - ./.ports.env
      - ./services/entitlement/.env.preview
    restart: unless-stopped
    volumes: []

  billing:
    environment:
      - APP_ENV=preview
      - LOG_LEVEL=info
    env_file:
      - ./.ports.env
      - ./services/billing/.env.preview
    restart: unless-stopped
    volumes: []

  health:
    environment:
      - LOG_LEVEL=info
    env_file:
      - ./.ports.env
      - ./services/health/.env.preview
    restart: unless-stopped
    volumes: []

  marketing:
    environment:
      - APP_ENV=preview
    env_file:
      - ./.ports.env
      - ./services/marketing/.env.preview
    restart: unless-stopped
    volumes: []

  cloud-adapter:
    environment:
      - APP_ENV=preview
    env_file:
      - ./.ports.env
      - ./services/cloud-adapter/.env.preview
    restart: unless-stopped
    volumes: []

  notification:
    environment:
      - APP_ENV=preview
      - LOG_LEVEL=info
    env_file:
      - ./.ports.env
      - ./services/notification/.env.preview
    restart: unless-stopped
    volumes: []

  storage:
    environment:
      - APP_ENV=preview
    restart: unless-stopped
    volumes: []

  # Plugins
  email:
    environment:
      - APP_ENV=preview
    env_file:
      - ./.ports.env
      - ./plugins/email/.env.preview
    restart: unless-stopped
    volumes: []

  sms:
    environment:
      - APP_ENV=preview
    env_file:
      - ./.ports.env
      - ./plugins/sms/.env.preview
    restart: unless-stopped
    volumes: []

  whatsapp:
    environment:
      - APP_ENV=preview
    env_file:
      - ./.ports.env
      - ./plugins/whatsapp/.env.preview
    restart: unless-stopped
    volumes: []

  telegram:
    environment:
      - APP_ENV=preview
    env_file:
      - ./.ports.env
      - ./plugins/telegram/.env.preview
    restart: unless-stopped
    volumes: []

  razorpay:
    env_file:
      - ./.ports.env
      - ./plugins/razorpay/.env.preview
    restart: unless-stopped
    volumes: []

  stripe:
    env_file:
      - ./.ports.env
      - ./plugins/stripe/.env.preview
    restart: unless-stopped
    volumes: []

  inventory:
    env_file:
      - ./.ports.env
      - ./plugins/inventory/.env.preview
    restart: unless-stopped
    volumes: []

  orders:
    env_file:
      - ./.ports.env
      - ./plugins/orders/.env.preview
    restart: unless-stopped
    volumes: []

  # Reverse Proxy (Nginx â€” simpler than Traefik, no SSL)
  nginx:
    image: nginx:alpine
    container_name: motherboard-nginx
    ports:
      - "80:80"
    volumes:
      - ./docker/nginx-preview.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - motherboard-network
    depends_on:
      - frontend
      - backend
    restart: unless-stopped

volumes:
  mongodb_preview:
    driver: local
